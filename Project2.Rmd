---
title: "Project2"
author: "Chih-Yu"
date: "01 December, 2023"
output:
  html_document:
    code_folding: show
    csl: biomed-central.csl
    df_print: paged
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    number_sections: yes
    theme: journal
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: 4
  pdf_document:
    df_print: kable
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    toc: yes
    toc_depth: 4

abstract: The project explores the application of Simple Linear Regression (SLR) to real-world data using R, specifically examining the relationship between fire damage and the distance from fire stations. The data is taken from table 10.9 in the textbook, the Statistics for Engineering and the Sciences, 6th (2016). The data contains 15 major residential fires in a large suburb, including the damage it caused to the distance to the fire station. The project aims to establish a statistical relationship between these two variables in order to help a fire insurance company to assess the risk and serve as the basis for the fair insurance rate. This study first visualizes the data and exhibits strong positive correlations.. The further analysis using SLR and the value of R-squared, suggests the linear model is the proper choice for the data, even though a quadratic model also has a good fit. The primary focus of this project is to predict the expected range of fire damage for residences located 3 miles away from a fire station. Then, the study found out the expected mean is 24.8541 thousand dollars with 95% confidence interval (23.57512. 26.1331). At the same time, this project acknowledges the limitations of a small dataset and suggests expanding the data collection for future studies.
---


<center>

![Chih-Yu Chu](chihyu_pic.jpg "My Picture"){ width=20% }
</center>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(dplyr)
```


# Introduction
Early this year, there was a debate emerged over the potential closure and consolidation of fire stations in the outlying areas in Sudbury, Canada. (Everson, 2023) This discussion was prompted when the government noticed the effectiveness of individual fire stations due to lack of funding and a shortage of volunteers. However, a group of local citizens stands on the negative side of the debate. They worried that the reducing fire station would increase response time, then potentially put their properties at greater risk and raise their fire insurance premiums. (White, 2023)   

Their concerns are justified and not unfounded. In the U.S., we can also observe a correlation between fire insurance rates and distance to a fire station in many cases. Although there are many factors determine the insurance rate, the Insurance Services Office (ISO) rating system, which evaluates a community’s fire protection capabilities, is the most significant one. (City of San Marcos) According to the study from ValuePenguin in 2021, the residents who live more than 25 miles farther from a fire station experience around 9% higher fire insurance than average in most states. In Alaska, comparing people who live within 1 mile,  residents living more than 25 miles from a fire station even faced up to 43% higher fire insurance costs. (ValuePenguin, 2021)   

<center>
![ISO in the San Marcos City(City of San Marcos)](ISO.png "ISO"){ width=70% }
</center>

## Data Overview
The response time is the primary grounded for the distance and insurance rate. When the house is closer to the fire station, it requires less response time, reducing the likelihood of extensive fire damage. (Dullum, 2021) Consequently, the company will take less risk, which is reflected in lower insurance premiums.    

Recognizing that the home insurance rate relates to the distance from the house to the fire station is crucial. However, the price level and effectiveness are vary in the different regions. Therefore, if the company would like to assess risk and determine the amount of insurance for the specific case, it is vital for it to examine the relationship between the distance of a residence from the nearest fire station and the expected fire damage in that region.  

The data in this study is collected as the fire insurance company wants to relate the amount of fire damage in major residential fires to the distance between the residence and its nearest fire station. The company would like to use this as the basis for the insurance rate in that region which both reflects the actual risk of the damage and is fair to the consumer. The dataset contains 15 most recent fire incidents in this selected region, including data on the extent of damage (in thousands of dollars) and the distance from each incident site to the nearest fire station (in miles).       

### Dataset
```{r}
fire=read.csv("FIREDAM.csv", header=TRUE)
head(fire)
```

### Variable 
There are two variables in the dataset: distance and damage. In this study, the distance between the household and the fire station is given, independent, so that we set x=distance; and the damage is random, depend on the distance, so we set y=damage.
```{r}
distance = fire$DISTANCE
damage = fire$DAMAGE
```

### Data plots
This is the preliminary plot to visualize the data. The two histograms show the distribution of two quantitative variables. The scatterplot combines two variables, and the regression line indicates the trend between them. The correlation coefficient on the bottom left shows the extent to which the two variables are related. The correlation coefficient is +0.96, meaning that the two variables have a positive relationship. Moreover, since the value is close to one, it implies that the relationship is strong and reliable between these variables. Furthermore, it supports that the company can be more confident in using this relationship to predict.
```{r}
library (s20x)
pairs20x(fire)
```

According to the above plot, the two variables (distance and damage cost) seem to be in a linear relation. The regression fitting with a loess line is generated to determine further whether a model can be fitted to a linear relationship and its correlation. In the plot, the black dot indicates the actual data, the blue line is the fitted line by loess method, and the shaded grey represents the confidence interval for the fitted line. According to this plot, the dot is generally close to the line, with no significant outliers. Therefore, there is no evidence so far to suggest that the line is not a good fit. However, there is not enough information about quantitatively assessing the goodness of fit. Therefore, the following statistical analysis will determine the degree to which this is true and will determine the extent of the actual relationship.

```{r}
library(ggplot2)
g = ggplot(fire, aes(x = distance, y = damage)) + geom_point()
g = g + geom_smooth(method = "loess") + ggtitle("demage vs distance ")
g
```

## Interest in the Data
The fire insurance company's key to calculating the insurance rate is based on accurately estimating the risk of potential fire damage to the property. Therefore, from its perspective, it is interested in the empirical relationship between fire damage and the distance from the fire station. In this relation, the company would like to find the expected value of the fire damage and establish the basis for setting up equitable insurance pricing models. In turn, the consumer also would like to know the anticipated damage value because it would help them to manage their risk and the cost. Hence, my interest in the data is the statistical relationship between the damage cost, the distance from the fire station, and the expected cost for the specific distance.  

## Research Question
What will be the expected range of fire damage for residences living 3 miles away from the fire station?

# Theory behind the Analysis (SLR)

From the first plot of the previous section, I get that distance from the fire station and fire damage has a strong positive relationship. However, from the second plot, I knew that they were not perfectly linear. To take the random variation of the data points about a line into account, the probabilistic model relating y to x will be more suitable for this data.

A simple linear regression model (SLR), a probabilistic model, is the model I will use in this study. According to the definition of the SLR, the mean of the y regard the given x (donate as $E(y|x)$) forms a straight line, and the difference between the actual value and the line, random error, equal to $\epsilon$ (could be either positive or negative).  

Therefore, the actual value could be expressed as : $y=\beta_0 + \beta_1x_i + \epsilon_i$.  

$y=\beta_0$ and $\beta_1$  are unknown parameters of the deterministic (nonrandom) part of the model. The mean value of y for the given x is the line,  $E(y|x)=\beta_0 + \beta_1x$. If the the point is lie on the line, then there will be no error, $E(\epsilon) = 0$. This will make the mean value of y:  


$$
E(y) = E(\beta_0 + \beta_1x + \epsilon) \\
 = \beta_0 + \beta_1x + E(\epsilon) \\
= \beta_0 + \beta_1x 
$$

This again suggests that the mean value of y for a given value of x, $E(y|x)$, will graphs as a straight line with the function: $E(y|x)=E(y) = \beta_0 + \beta_1x$, where $\beta_0$ is the y-intercept and $\beta_1$ is the slope.

## Assumptions for valid inferences
To carry out SLR, the estimators for the unknown parameters, $\beta_0$, $\beta_1$, and $E(y)$ has to be find. The valid inferences about $\beta_0$ and $\beta_1$ are depend on the sampling distribution of the estimator, which in turn depend on the probability distribution of the random, $\epsilon$. In the other words, $\epsilon$ plays the critical role to fit SLR to the data. Therefore, 4 assumptions of the $\epsilon$ is necessary to be made: 

1. $E(\epsilon) = 0$. This assumption is to try to keep the formula above unchanged and unbiased: $E(y)= \beta_0 + \beta_1x$   
2. $V(\epsilon) = constant$ for all value of x. This assumption base on the property of independence x.  
3. the probability distribution of $\epsilon$ is normal  
4. $\epsilon$ is independent. This suggest that y vales are independent one another. 

## Estimating the parameters
The best fit line is the line with  minimum sum of squares of the deviations, which is called the method of least squares. And this line could be written as:
$$
\hat{y}_{i} = \hat{\beta}_{0} + \hat{\beta}_{1}x_i
$$


```{r}
fire.lm= with(fire, lm(DAMAGE~DISTANCE, data=fire))
summary(fire.lm)
```

From the summary, we get:
$$
\hat{\beta}_{0} = 10.2779 
$$

$$
\hat{\beta}_{1} = 4.9193
$$

## Confidence Interval for Parameter Estimates
```{r}
ciReg(fire.lm, conf.level=0.95, print.out=TRUE)
```

this the 95% confidence interval for Parameter Estimates

## Least-Squares Estimates
Conclude above, the equation for Least-Squares Estimates is:  
$$
\hat{y}_{i} = \hat{\beta}_{0} + \hat{\beta}_{1}x_i = 10.2779 +4.9193x_i
$$

the y-intercept is 10.2779 and the slope is 4.9193. It implies that when the expected damage will increase by 4.9193 thousand dollars for marginal mile away from the fire station, while the value are within the confidence interval.

# Check on validity
## Straight trend line
Create the trendscatter plot, in order to visualize the relation between the point with lowess trend line. This plot has the similar output with the one made with ggplot previous: there is no evidence so far to suggest that the line is not a good fit. However, there also has not enough information about quantitatively assessing the good fit of the line.
```{r}
fireline = trendscatter (DAMAGE~DISTANCE, data=fire)
```

Assume it is a straight line relationship and make a linear model object
```{r}
fire.lm
```

```{r}
with (fire, plot(DAMAGE~DISTANCE, 
                     main = "DAMAGE vs DISTANCE", 
                     xlab = "miles",
                     ylab = "dollars",
                     pch = 21, bg = "Blue", cex = 1.2,
                     xlim = c(0, max(DISTANCE) * 1.1),
                     ylim = c(0, max(DAMAGE) * 1.1)))
abline(fire.lm)
```

This scatter plot is show fitted straight line for the date. It seem to be a good fit for the data, but the nationalistically still need to be further determine the good fit.

```{r}
# linear model
fire.lm= with(fire, lm(DAMAGE~DISTANCE, data=fire))
#find the residuals
height.res = residuals(fire.lm)
#finf the fitted value\
height.fit = fitted(fire.lm)
```

### RSS
```{r}
hat = with(fire, predict(fire.lm, data.frame(DISTANCE)))
yhat = fitted(fire.lm)
with(fire, 
     plot(DAMAGE~DISTANCE, main = "Residula line segments of distance vs damage (RSS)", 
          xlab = "distance (miles)",
          ylab = "damage (dollars)",
          pch = 21, bg = "Blue", cex = 1.0,
          xlim = c(0, max(DISTANCE) * 1.1),
          ylim = c(0, max(DAMAGE) * 1.1)))
with(fire, {
  segments(DISTANCE, DAMAGE, DISTANCE, yhat)
})
abline(fire.lm)
```

This plot of residual line segments allow us to visualize the extent to which the points vary from the line we are trying to fit into the data. This distance of the line it draw is also the value of the  $\epsilon$. 

```{r}
RSS = with(fire, sum((DAMAGE - yhat) ^ 2))
RSS
```

Nevertheless, this also provide RSS, which we will use to calculate the value of $R^2$ of the line.

### MSS

```{r}
with(fire, 
     plot(DAMAGE~DISTANCE, main = "Mean of distance vs damage (MSS)", 
          xlab = "distance (miles)",
          ylab = "damage (dollars)",
          pch = 21, bg = "Blue", cex = 1.0,
          xlim = c(0, max(DISTANCE) * 1.1),
          ylim = c(0, max(DAMAGE) * 1.1)))
with(fire, abline(h = mean(DAMAGE)))
with(fire, segments(DISTANCE, mean(DAMAGE), DISTANCE, yhat, col = "Red"))
abline(fire.lm)
```

This plot of mean visualizes the fitted line and deviations of the fitted line from the mean height added.  

```{r}
MSS = with(fire, sum((yhat - mean(DAMAGE)) ^ 2))
MSS
```

Meanwhile,  this also provide MSS, which we will use to calculate the value of $R^2$ of the line.

### TSS


```{r}
with (fire,
      plot(DAMAGE~DISTANCE, main = "Total Deviation Line Segments of distance vs damage (TSS)", 
          xlab = "distance (miles)",
          ylab = "damage (dollars)",
          pch = 21, bg = "Blue", cex = 1.0,
          xlim = c(0, max(DISTANCE) * 1.1),
          ylim = c(0, max(DAMAGE) * 1.1)))
with(fire, abline(h = mean(DAMAGE)))
with(fire, segments(DISTANCE, DAMAGE, DISTANCE, mean(DAMAGE), col = "Green"))
```

This plot show th total deviation line segments, $\hat{y} = \bar{y}$

```{r}
TSS = with(fire, sum( (DAMAGE - mean(DAMAGE)) ^2 ))
TSS   
```
Here we also could calculated TSS. total sum of squares.

### Check if TSS = MSS+RSS
check if there is not mistake in calculation
```{r}
MSS+RSS
TSS
```

### $R^2$ = MSS/TSS
The ratio of MSS/TSS represent the proportion of the total variability in the data that is explained by a statistical model. And the ratio is range between 0 to 1. In this case, the ratio value is 0.9235, really close to 1. Therefore, this suggests that the model (straight line) is the good fit for the data.
```{r}
R2 <- MSS/TSS
R2
```
## $E(\epsilon) = 0$
The null hypothesis is that the mean of the residuals is zero.
```{r}
residuals <- resid(fire.lm)
meanr <- mean(residuals)
meanr
t.test(residuals)
```

The mean of the residuals ($4.04e-17$) is effectively zero.
From the t.test, the 95% confidence interval for the mean of the residuals includes zero, which is consistent with the hypothesis that the residuals have a zero mean. Then, the p-value is 1, which is significantly greater than the standard of comparison, 0.05), therefore, it further suggest that there is no evidence to reject the null hypothesis. Therefore, we could resonly assuem that $E(\epsilon) = 0$.

##  Constant variance


```{r}
#Find residuals
height.res = residuals(fire.lm)
#Find the fitted value
height.fit = fitted(fire.lm)

trendscatter(y = height.res, x = height.fit, 
             main ="Residuals and the fitted value",
             xlab= "fitted value",
             ylab= "esiduals value")
```

Here, the uniformity is about 0. Therefore, it support the linear model is good fit for the dataset again.


## errors distribution normally
The null hypothesis is errors distribution normally: 
$$ 
\epsilon \sim N(0, \sigma^2)
$$

```{r}
normcheck(fire.lm, shapiro.wilk = TRUE)
```

The p-value is 0.474, which is significantly greater than the standard of comparison, 0.05. Therefore, there is not enough evidence to reject the null hypothesis. In the other words, we could reasonably assume that the data is distributed normally.

## Independence of data
The data is collected randomly with the 15 most recent fires. Random sampling will result in independent response variables, therefore this assumption is also true. 

# Test anthother model
According to above, I conclude that the linear model is a good fit for this dataset. However, it is not the only possibility. Hence, to check that if it is actually a best fit, I am going to compare it with the quadratic model.

## quadratic model

The formula for the quadratic model is:  
$$
y_i = \beta_0+\beta_1x_i+\beta_2x_i^2
$$

## Fit a quadratic to the points
```{r}
# Fit a quadratic to the points
quad.lm = lm(DAMAGE~DISTANCE + I(DISTANCE^2), data=fire)
# Scatter plot of DAMAGE vs DISTANCE and add the quadratic curve to it.
plot(DAMAGE~DISTANCE,bg="Blue",pch=21,cex=1.2,
   ylim=c(0,1.1*max(DAMAGE)),
   xlim=c(0,1.1*max(DISTANCE)),
   main="DAMAGE vs DISTANCE",data=fire)
myplot = function(x){quad.lm$coef[1] + quad.lm$coef[2]*x + quad.lm$coef[3]*x^2}
curve(myplot, lwd = 2, add = TRUE)
```

The is the Scatter plot of DAMAGE vs DISTANCE and the its quadratic curve. 

## plots of residuals vs fitted values
```{r}
# Make quad.fit
quad.fit = fitted(quad.lm)
# plot
plot(quad.lm, which = 1)
```

The plots show the residuals distributed symmetrically around the horizontal line at y=0, indicating no systematic bias above or below this line. However, there are outliers exist. 


## check normality
The null hypothesis is errors distribution normally: 
$$ 
\epsilon \sim N(0, \sigma^2)
$$

```{r}
normcheck(quad.lm, shapiro.wilk = TRUE)
```

The p-value is 0.329, which is significantly greater than the standard of comparison, 0.05. Therefore, there is not enough evidence to reject the null hypothesis. In the other words, we could reasonably assume that the data is distributed normally.

## Summarize the quadratic model
```{r}
coef(quad.lm)
```

$$
\\  \hat{\beta}_{0} = 13.3395167 
$$

$$
\\ \hat{\beta}_{1} = 2.6400145
$$

$$
\\ \hat{\beta}_{2} = 0.3375741
$$

the fitted line is:
$$
\\ \hat{y}_{i} = \hat{\beta}_{0} + \hat{\beta}_{1}x  + \hat{\beta}_{2}x^2
$$

$$
\\ \hat{damage} = 13.3395167 + 2.6400145x   +0.3375741x^2
$$

## Comparing two model with $R^2$
### Multiple R-squared $R^2$
```{r}
summary(fire.lm)$r.squared 
summary(quad.lm)$r.squared 
```

R-squared represents the proportion of the variance in the dependent variable explained by the independent variables. And in this case, it indicate how well the model itself describe the data.  
The $R^2$ for the linear model is 0.9234782  
The $R^2$ for the quadratic model is 0.9347158  
Comparing with two value, since the quadratic model has the higher value of R-squared (0.9347158), it mean that it is the better model to describe the data. However, because both value are close to 1, and close to one another, I am going to adjusted R-squared to the the further analysis. 

### Adjusted R-squared
```{r}
summary(fire.lm)$adj.r.squared 
summary(quad.lm)$adj.r.squared
```
Adjusted R-squared provides a more accurate measure of the model’s goodness of fit by going up when adding more variables and penalizing excessive variables. In this case, since quad.lm has the higher value of adjusted R-squared, it again indicate that quadratic model is the comparing better fit as a model.

### Using Anova as Confirmation

Since two models have the similar value of $R^2$ and $adjusted \ R^2$, I am going to use anova to compare the two models and make final decision.

```{r}
anova(fire.lm)
anova(quad.lm)
anova(fire.lm,quad.lm)
```

According to the information above, both models have nearly 0 p-values, indicating they fit well. Thus, I set the null hypothesis to be that the quadratic term does not contribute significantly to the model.  
Then I do the Anova for both model. From the test, I get p-value equal to 0.1762, which is greater than 0.05. Therefore, fail to reject the null hypothesis.  
To conclude, the comparing with the linear model, quadratic model is the better fit for the data. However, the improvement is not significant. Therefore, I think linear model, the simper model, is the more appropriate choice.

# Analysis of the data
## Avoid Bias by using Cook’s Distance
According the finding, I decide to take linear modal as the fit model for this data. However, I noticed there are outlier in this data. Therefore, i am going to use Cook's Distance to avoid the bias.
```{r}
cooks20x(fire.lm)
```

According to the output, the observation number with 13 is have the externally large Cook's distance. And it might be the outlier. Therefore, I am going to delete this data make a new model and keep the same liner to see if it will increase the fitness. 

```{r}
fire2.lm=lm(DAMAGE~DISTANCE, data=fire[-13,])
summary(fire2.lm)
```

Called the original data to compare;

```{r}
summary(fire.lm)
```

We can see that the residual standard error decreased, from 12 degrees of freefom to 13 degree of freedom; the multiple $R^2$ is increased, from 0.9053 to 0.9235; and the adjusted R-squared also increase form 0.8975 to 0.9176  Based on this comparison we can conclude that data with the observation number is outlier and remove it will make the model have the better fit.

## predict the data
Assume the distance = 3, find the the expected value of y with 95% confidence interval
```{r}
# create a new data
new <- data.frame(DISTANCE = 3)

# Make a prediction and get the 95% confidence intervals
predictions <- predict(fire2.lm, newdata = new, interval = "confidence", level = 0.95)

print(predictions)
```

According to the output data, when distance = 3 miles from the fire station, the expected mean value of fire damage will the 24.8541 thousand with 95% confidence interval (23.57512. 26.1331)

# Conclusion
## Answer the research question  
In this study, I applied SLR and found this data could fit both the linear model and the quadratic model. Although the quadratic model has a slightly higher fit, considering the slight improvement it could make and the effectiveness of analysis, the linear model is the appropriate choice.

By using the linear model and deleting the outlier, I predict that if the household is 3 miles away from the fire station, the expected mean of it fire damage would be 24.8541 thousand dollars. The 95% confidence interval is between 23.57512 thousand dollars to 26.1331 thou.sand dollars

## Suggest ways to improve model or experiment  
The data is conducted in a large suburb of a major city, however, there are only 14 available data. A small amount of data may be insufficiently representative, so I suggest to collect more data next time as well as take more time to collect data. Beside adding more data, I think this model could also be improved be deleted the outlier (in the begin of analysis).  

# Reference
Everson, Alana, and Alana Everson. 2023. “Greater Sudbury Community Worried Volunteer Fire Hall Will Close.” Northern Ontario. CTV News. February 17, 2023. https://northernontario.ctvnews.ca/greater-sudbury-community-worried-volunteer-fire-hall-will-close-1.6277588.  

White, Erik. 2023. “Fire Insurance Rates at the Heart of the Debate over Closing Fire Halls in Greater Sudbury.” CBC. May 4, 2023. https://www.cbc.ca/news/canada/sudbury/fire-insurance-rates-fire-halls-greater-sudbury-northern-ontario-1.6829123.  

“ISO - Insurance Services Office Rating | City of San Marcos, TX.” 2023. Sanmarcostx.gov. 2023. https://sanmarcostx.gov/1142/ISO---Insurance-Services-Office-Rating.  

Hurst, Andrew. 2021. “Rural Counties Have More Firefighters per Home but Their Residents Pay More for Insurance Because They’re Farther from Fire Stations.” ValuePenguin. ValuePenguin. June 7, 2021. https://www.valuepenguin.com/access-to-fire-stations.  

Dullum, Gregory. 2023. “Improved ISO Ratings May Lower Insurance Premiums — the Cash-Book Journal.” The Cash-Book Journal. March 2023. https://thecash-book.com/news/county-news/improved-iso-ratings-may-lower-insurance-premiums/.  


